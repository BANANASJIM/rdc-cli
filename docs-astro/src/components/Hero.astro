---
import stats from "../data/stats.json";

const base = import.meta.env.BASE_URL;
---

<section class="relative min-h-screen flex items-center justify-center pt-16 overflow-hidden bg-gpu-dark">
  <!-- Subtle grid background -->
  <div class="absolute inset-0 bg-[size:72px_72px] [mask-image:radial-gradient(ellipse_50%_50%_at_50%_50%,black_30%,transparent_100%)]" style="background-image: linear-gradient(rgb(var(--accent) / 0.03) 1px, transparent 1px), linear-gradient(90deg, rgb(var(--accent) / 0.03) 1px, transparent 1px);"></div>

  <!-- Very subtle radial glow â€” low opacity, no animation -->
  <div class="absolute top-1/3 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[700px] h-[500px] rounded-full pointer-events-none" style="background: radial-gradient(ellipse, rgb(var(--accent) / 0.06) 0%, transparent 70%);"></div>
  <div class="absolute top-[40%] left-[35%] w-[300px] h-[300px] rounded-full pointer-events-none" style="background: radial-gradient(circle, rgb(var(--accent-dim) / 0.04) 0%, transparent 70%);"></div>

  <div class="relative z-10 max-w-5xl mx-auto px-6 text-center">
    <!-- Large ASCII logo with text-shadow glow -->
    <div class="mb-8 relative inline-block">
      <pre class="font-mono text-gpu-accent text-lg md:text-2xl lg:text-3xl leading-tight select-none tracking-tight" aria-hidden="true" style="text-shadow: 0 0 20px rgb(var(--accent) / 0.3), 0 0 40px rgb(var(--accent) / 0.08);">
 _ __ __| | ___
| '__/ _` |/ __|
| | | (_| | (__
|_|  \__,_|\___|</pre>
    </div>

    <!-- Headline -->
    <h1 class="text-5xl md:text-7xl lg:text-8xl font-extrabold mb-6 tracking-tight">
      <span class="gradient-text">Unix CLI</span>
      <br />
      <span class="text-gray-100">for RenderDoc</span>
    </h1>

    <!-- Subtitle -->
    <p class="text-lg md:text-xl text-gray-400 max-w-2xl mx-auto mb-12 leading-relaxed">
      {stats.command_count} commands. TSV pipes. JSON mode.<br />
      Designed for <span class="text-gpu-accent font-medium">CI pipelines</span> and <span class="text-gpu-purple font-medium">AI agents</span>.
    </p>

    <!-- Terminal session replay -->
    <div class="max-w-2xl mx-auto mb-14">
      <div class="terminal-window glow-accent">
        <div class="terminal-header">
          <span class="terminal-dot bg-[#ff5f57]"></span>
          <span class="terminal-dot bg-[#febc2e]"></span>
          <span class="terminal-dot bg-[#28c840]"></span>
          <span class="ml-auto text-[10px] text-gray-500 font-mono tracking-wider uppercase">rdc-cli</span>
        </div>
        <div id="replay-terminal" class="terminal-body text-left overflow-y-auto text-xs md:text-sm transition-[height] duration-300 ease-out" style="min-height: 2.5rem; max-height: 24rem;">
          <div id="replay-lines"></div>
        </div>
      </div>
    </div>

    <!-- CTA buttons -->
    <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
      <a
        href={`${base}docs/install/`}
        class="px-8 py-3.5 bg-gpu-accent text-gpu-dark font-bold rounded-lg transition-all duration-300 hover:shadow-[0_0_30px_rgb(var(--accent)/0.3)] hover:scale-[1.02]"
      >
        Get Started
      </a>
      <a
        href={`${base}docs/`}
        class="px-8 py-3.5 border border-gpu-border text-gray-300 rounded-lg transition-all duration-300 hover:text-gpu-accent hover:border-gpu-accent/30"
      >
        Documentation
      </a>
      <a
        href="https://github.com/BANANASJIM/rdc-cli"
        target="_blank"
        rel="noopener noreferrer"
        class="px-8 py-3.5 border border-gpu-border text-gray-300 rounded-lg transition-all duration-300 hover:text-gpu-accent hover:border-gpu-accent/30"
      >
        GitHub
      </a>
    </div>
  </div>

  <!-- Bottom fade -->
  <div class="absolute bottom-0 left-0 right-0 h-32 bg-gradient-to-t from-gpu-dark to-transparent"></div>
</section>

<script>
  import playlists from '../data/replay.json';

  const container = document.getElementById('replay-lines')!;
  const terminal = document.getElementById('replay-terminal')!;

  const TYPE_SPEED = 20;
  const OUTPUT_LINE_DELAY = 30;
  const SCENE_PAUSE = 1400;
  const RESTART_PAUSE = 2000;

  let playlistIndex = 0;

  function sleep(ms: number) { return new Promise(r => setTimeout(r, ms)); }

  function scrollToBottom() {
    terminal.scrollTop = terminal.scrollHeight;
  }

  function createPromptLine(): { el: HTMLDivElement; span: HTMLSpanElement } {
    const el = document.createElement('div');
    el.className = 'flex items-start';
    el.innerHTML = '<span class="text-gpu-green mr-2 select-none font-bold shrink-0">$</span>';
    const span = document.createElement('span');
    span.className = 'text-gray-200';
    el.appendChild(span);
    const cursor = document.createElement('span');
    cursor.className = 'replay-cursor';
    cursor.textContent = '\u2588';
    el.appendChild(cursor);
    container.appendChild(el);
    return { el, span };
  }

  async function typeCommand(text: string) {
    const { el, span } = createPromptLine();
    scrollToBottom();
    for (const ch of text) {
      span.textContent += ch;
      scrollToBottom();
      await sleep(TYPE_SPEED);
    }
    el.querySelector('.replay-cursor')?.remove();
  }

  function renderOutputLine(line: string): HTMLDivElement {
    const div = document.createElement('div');
    div.className = 'text-gray-400 pl-0 whitespace-pre';

    // TSV header (all-caps tab-separated)
    if (/^\t*[A-Z_]+(\t[A-Z_]+)+$/.test(line)) {
      div.className = 'text-gray-500 pl-0 whitespace-pre';
      div.textContent = line.replace(/\t/g, '  ');
      return div;
    }

    // Key-value lines (like rdc info)
    const kvMatch = line.match(/^(\w[\w\s]*?)\s{2,}(.+)$/);
    if (kvMatch) {
      const k = document.createElement('span');
      k.className = 'text-gray-500';
      k.textContent = kvMatch[1];
      div.appendChild(k);
      div.appendChild(document.createTextNode('  '));
      const v = document.createElement('span');
      v.className = 'text-gray-300';
      v.textContent = kvMatch[2];
      div.appendChild(v);
      return div;
    }

    // TSV data rows
    if (line.includes('\t')) {
      div.textContent = line.replace(/\t/g, '  ');
      div.className = 'text-gray-300 pl-0 whitespace-pre';
      return div;
    }

    // JSON
    if (/^\s*[{}\[\]"]/.test(line)) {
      div.className = 'text-gray-400 pl-0 whitespace-pre';
      div.textContent = line;
      return div;
    }

    div.textContent = line;
    return div;
  }

  async function showOutput(output: string) {
    if (!output) return;
    for (const line of output.split('\n')) {
      container.appendChild(renderOutputLine(line));
      scrollToBottom();
      await sleep(OUTPUT_LINE_DELAY);
    }
  }

  async function runReplay() {
    while (true) {
      const playlist = playlists[playlistIndex % playlists.length];
      playlistIndex++;
      container.innerHTML = '';

      for (const scene of playlist) {
        await typeCommand(scene.cmd);
        await sleep(200);
        await showOutput(scene.output);
        await sleep(SCENE_PAUSE);
      }
      await sleep(RESTART_PAUSE);
    }
  }

  runReplay();
</script>
